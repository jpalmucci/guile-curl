;; -*- Mode: scheme; -*-
(define-module (XXpackageXX curl)
  #:use-module (srfi srfi-1)
  #:use-module (rnrs bytevectors)
  #:export ( 
	    handle?
	    curl-easy-init
	    curl-easy-setopt
	    curl-easy-perform
	    curl-easy-cleanup
	    curl-easy-reset
	    curl-error-string
	    curl-error-code
	    
	    CURL_HTTP_VERSION_NONE
	    CURL_HTTP_VERSION_1_0
	    CURL_HTTP_VERSION_1_1

	    CURL_NETRC_OPTIONAL
	    CURL_NETRC_IGNORED
	    CURL_NETRC_REQUIRED

	    CURL_REDIR_POST_301
	    CURL_REDIR_POST_302
	    CURL_REDIR_POST_ALL

	    CURLAUTH_BASIC
	    CURLAUTH_DIGEST
	    CURLAUTH_DIGEST_IE
	    CURLAUTH_GSSNEGOTIATE
	    CURLAUTH_NTLM
	    CURLAUTH_ANY
	    CURLAUTH_ANYSAFE
	    CURLAUTH_ONLY

	    CURLE_OK
	    CURLE_UNSUPPORTED_PROTOCOL
	    CURLE_FAILED_INIT
	    CURLE_URL_MALFORMAT
	    CURLE_URL_MALFORMAT_USER
	    CURLE_COULDNT_RESOLVE_PROXY
	    CURLE_COULDNT_RESOLVE_HOST
	    CURLE_COULDNT_CONNECT
	    CURLE_FTP_WEIRD_SERVER_REPLY
	    CURLE_FTP_ACCESS_DENIED
	    CURLE_FTP_USER_PASSWORD_INCORRECT
	    CURLE_FTP_WEIRD_PASS_REPLY
	    CURLE_FTP_WEIRD_USER_REPLY
	    CURLE_FTP_WEIRD_PASV_REPLY
	    CURLE_FTP_WEIRD_227_FORMAT
	    CURLE_FTP_CANT_GET_HOST
	    CURLE_FTP_CANT_RECONNECT
	    CURLE_FTP_COULDNT_SET_BINARY
	    CURLE_PARTIAL_FILE
	    CURLE_FTP_COULDNT_RETR_FILE
	    CURLE_FTP_WRITE_ERROR
	    CURLE_FTP_QUOTE_ERROR
	    CURLE_HTTP_RETURNED_ERROR
	    CURLE_WRITE_ERROR
	    CURLE_MALFORMAT_USER
	    CURLE_UPLOAD_FAILED
	    CURLE_READ_ERROR
	    CURLE_OUT_OF_MEMORY
	    CURLE_OPERATION_TIMEOUTED
	    CURLE_FTP_COULDNT_SET_ASCII
	    CURLE_FTP_PORT_FAILED
	    CURLE_FTP_COULDNT_USE_REST
	    CURLE_FTP_COULDNT_GET_SIZE
	    CURLE_HTTP_RANGE_ERROR
	    CURLE_HTTP_POST_ERROR
	    CURLE_SSL_CONNECT_ERROR
	    CURLE_BAD_DOWNLOAD_RESUME
	    CURLE_FILE_COULDNT_READ_FILE
	    CURLE_LDAP_CANNOT_BIND
	    CURLE_LDAP_SEARCH_FAILED
	    CURLE_LIBRARY_NOT_FOUND
	    CURLE_FUNCTION_NOT_FOUND
	    CURLE_ABORTED_BY_CALLBACK
	    CURLE_BAD_FUNCTION_ARGUMENT
	    CURLE_BAD_CALLING_ORDER
	    CURLE_INTERFACE_FAILED
	    CURLE_BAD_PASSWORD_ENTERED
	    CURLE_TOO_MANY_REDIRECTS
	    CURLE_UNKNOWN_TELNET_OPTION
	    CURLE_TELNET_OPTION_SYNTAX
	    CURLE_OBSOLETE
	    CURLE_SSL_PEER_CERTIFICATE
	    CURLE_GOT_NOTHING
	    CURLE_SSL_ENGINE_NOTFOUND
	    CURLE_SSL_ENGINE_SETFAILED
	    CURLE_SEND_ERROR
	    CURLE_RECV_ERROR
	    CURLE_SHARE_IN_USE
	    CURLE_SSL_CERTPROBLEM
	    CURLE_SSL_CIPHER
	    CURLE_SSL_CACERT
	    CURLE_BAD_CONTENT_ENCODING
	    CURLE_LDAP_INVALID_URL
	    CURLE_FILESIZE_EXCEEDED
	    CURLE_FTP_SSL_FAILED
	    CURLE_SEND_FAIL_REWIND
	    CURLE_SSL_ENGINE_INITFAILED
	    CURLE_LOGIN_DENIED
	    CURLE_TFTP_NOTFOUND
	    CURLE_TFTP_PERM
	    CURLE_TFTP_DISKFULL
	    CURLE_TFTP_ILLEGAL
	    CURLE_TFTP_UNKNOWNID
	    CURLE_TFTP_EXISTS
	    CURLE_TFTP_NOSUCHUSER
	    CURLE_CONV_FAILED
	    CURLE_CONV_REQD
	    CURLE_SSL_CACERT_BADFILE
	    CURLE_REMOTE_FILE_NOT_FOUND
	    CURLE_SSH
	    CURLE_SSL_SHUTDOWN_FAILED

	    CURLPROTO_HTTP
	    CURLPROTO_HTTPS
	    CURLPROTO_FTP
	    CURLPROTO_FTPS
	    CURLPROTO_SCP
	    CURLPROTO_SFTP
	    CURLPROTO_TELNET
	    CURLPROTO_LDAP
	    CURLPROTO_LDAPS
	    CURLPROTO_DICT
	    CURLPROTO_FILE
	    CURLPROTO_TFTP
	    CURLPROTO_IMAP
	    CURLPROTO_IMAPS
	    CURLPROTO_POP3
	    CURLPROTO_POP3S
	    CURLPROTO_SMTP
	    CURLPROTO_SMTPS
	    CURLPROTO_RTSP
	    CURLPROTO_RTMP
	    CURLPROTO_RTMPT
	    CURLPROTO_RTMPE
	    CURLPROTO_RTMPTE
	    CURLPROTO_GOPHER
	    CURLPROTO_ALL

	    CURLPROXY_HTTP
	    CURLPROXY_HTTP_1_0
	    CURLPROXY_SOCKS4
	    CURLPROXY_SOCKS5
	    CURLPROXY_SOCKS4A
	    CURLPROXY_SOCKS5_HOSTNAME

	    ))

(load-extension "XXlibnameXX" "cl_init")

(define (c-bool x)
  (if x
      1
      0))

(define (num->ascii-hex-num x)
  "Given a number between 0 and 15, it returns
the ASCII character code of the hex digit 0123456789ABCDEF"
  (cond
   ((and (>= x 0) (<= x 9))
    (+ x 48))				; 47 == #\0
   ((and (>= x 10) (<= x 15))
    (+ (- x 10) 65))			; 65 is #\A
   (else
    (error "out of range"))))

(define (u8->encoded-u8-triplet x)
  "Converts the u8 integer X into a list of three integers
that are the ASCII character codes of PERCENT_SIGN +
HEXADECIMAL + HEXADECIMAL"
  (list 37				; PERCENT SIGN
	(num->ascii-hex-num (quotient x 16))
	(num->ascii-hex-num (remainder x 16))))

(define (bv->url-encoded-bv bv)
  "Creates a bytevector that contains a URL-encoded representation
of the original bytevector"
  (u8-list->bytevector
   (fold 
    (lambda (x prev)
      (cond
       ((or (= x 33)			; #\!
	    (= x 36)			; #\$
	    (and (>= x 39) (<= x 57))	; #\` to #\9
	    (and (>= x 65) (<= x 90))	; #\A to #\Z
	    (= x 95)			; #\_
	    (and (>= x 97) (<= x 122))) ; #\a to #\z
	(append prev (list x)))
       (else
	(append prev (u8->encoded-u8-triplet x)))))
    '()
    (bytevector->u8-list bv))))

(define (curl-easy-init)
  "Returns a curl handle that you must use as input to other functions.
This handle represents one connection to a server."
  (%curl-easy-init))

(define (curl-easy-cleanup handle)
  "This forcibly closes all connections that this handle has used
and has possibly kept open until now.  Any use of the handle
after it has been closed is invalid.

Calling this procedure is optional: handles will automatically
be freed when no longer in use."
  (%curl-easy-cleanup handle))

(define (curl-easy-reset handle)
  "Re-initializes all options previously set on this CURL handle
to its default values.

It does not change live connections, the Session ID cache, the DNS
cache, the cookies or the shared."
  (%curl-easy-reset handle))

(define symbol-options
  `(
    ;; BEHAVIOR OPTIONS
    (verbose ,CURLOPT_VERBOSE boolean)
    (header ,CURLOPT_HEADER boolean)
    (nosignal ,CURLOPT_NOSIGNAL boolean)
    (wildcardmatch ,CURLOPT_WILDCARDMATCH boolean)

    ;; NETWORK OPTIONS
    (url ,CURLOPT_URL string)
    (protocols ,CURLOPT_PROTOCOLS integer)
    (redir-protocols ,CURLOPT_REDIR_PROTOCOLS integer)
    (proxy ,CURLOPT_PROXY string)
    (proxyport ,CURLOPT_PROXYPORT integer)
    (proxytype ,CURLOPT_PROXYTYPE integer)
    (noproxy ,CURLOPT_NOPROXY string)
    (httpproxytunnel ,CURLOPT_HTTPPROXYTUNNEL boolean)
    (socks5-gssapi-service ,CURLOPT_SOCKS5_GSSAPI_SERVICE string)
    (socks5-gssapi-nec ,CURLOPT_SOCKS5_GSSAPI_NEC boolean)
    (interface ,CURLOPT_INTERFACE string)
    (localport ,CURLOPT_LOCALPORT integer)
    (localportrange ,CURLOPT_LOCALPORTRANGE integer)
    (dns-cache-timeout ,CURLOPT_DNS_CACHE_TIMEOUT integer)
    (buffersize ,CURLOPT_BUFFERSIZE integer)
    (port ,CURLOPT_PORT integer)
    (tcp-nodelay ,CURLOPT_TCP_NODELAY boolean)
    (address-scope ,CURLOPT_ADDRESS_SCOPE integer)

    ;; NAMES AND PASSWORD OPTIONS
    (netrc ,CURLOPT_NETRC integer)
    (netrc-file ,CURLOPT_NETRC_FILE string)
    (userpwd ,CURLOPT_USERPWD string)
    (proxyuserpwd ,CURLOPT_PROXYUSERPWD string)
    (username ,CURLOPT_USERNAME string)
    (password ,CURLOPT_PASSWORD string)
    (proxyusername ,CURLOPT_PROXYUSERNAME string)
    (proxypassword ,CURLOPT_PROXYPASSWORD string)
    (httpauth ,CURLOPT_HTTPAUTH integer)
    (proxyauth ,CURLOPT_PROXYAUTH integer)

    ;; HTTP OPTIONS
    (autoreferer ,CURLOPT_AUTOREFERER boolean)
    (encoding ,CURLOPT_ENCODING string)
    (followlocation ,CURLOPT_FOLLOWLOCATION boolean)
    (unrestricted-auth ,CURLOPT_UNRESTRICTED_AUTH boolean)
    (maxredirs ,CURLOPT_MAXREDIRS integer)
    (postredir ,CURLOPT_POSTREDIR integer)
    (put ,CURLOPT_PUT boolean)
    (post ,CURLOPT_POST boolean)
    (httppost ,CURLOPT_HTTPPOST httppost)
    (referer ,CURLOPT_REFERER string)
    (useragent ,CURLOPT_USERAGENT string)
    (httpheader ,CURLOPT_HTTPHEADER slist)
    (http200aliases ,CURLOPT_HTTP200ALIASES slist)
    (cookie ,CURLOPT_COOKIE string)
    (cookiefile ,CURLOPT_COOKIEFILE string)
    (cookiejar ,CURLOPT_COOKIEJAR string)
    (cookiesession ,CURLOPT_COOKIESESSION boolean)
    (cookielist ,CURLOPT_COOKIELIST string)
    (httpget ,CURLOPT_HTTPGET boolean)
    (http-version ,CURLOPT_HTTP_VERSION integer)
    (ignore-content-length ,CURLOPT_IGNORE_CONTENT_LENGTH boolean)
    (http-content-decoding ,CURLOPT_HTTP_CONTENT_DECODING boolean)
    (http-transfer-decoding ,CURLOPT_HTTP_TRANSFER_DECODING boolean)

    ;; CONNECTION OPTIONS
    (timeout ,CURLOPT_TIMEOUT integer)
    (timeout-ms ,CURLOPT_TIMEOUT integer)
    (low-speed-limit ,CURLOPT_LOW_SPEED_LIMIT integer)
    (low-speed-time ,CURLOPT_LOW_SPEED_TIME integer)
    (maxconnects ,CURLOPT_MAXCONNECTS integer)
    (fresh-connect ,CURLOPT_FRESH_CONNECT boolean)
    (forbid-reuse ,CURLOPT_FORBID_REUSE boolean)
    (connecttimeout ,CURLOPT_CONNECTTIMEOUT integer)
    (connecttimeout-ms ,CURLOPT_CONNECTTIMEOUT_MS integer)
    (ipresolve ,CURLOPT_IPRESOLVE integer)
    (connect-only ,CURLOPT_CONNECT_ONLY boolean)))

(define* (curl-easy-setopt handle option arg)
  "Apply the option and argument to a given handle.

Returns #t on success and #f on failure."

  ;; First, check the special case options
  (cond
   ((and (eq? option 'postfields)
	 (bytevector? arg))
    (and (%curl-easy-setopt handle CURLOPT_POSTFIELDS arg)
	 (%curl-easy-setopt handle CURLOPT_POSTFIELDSIZE 
			    (bytevector-length arg))))
   (else
    ;; Now, try the more generic options
    (let ((value (assq-ref symbol-options option)))
      (if value
	  (let ((option (car value))
		(type (cadr value)))
	    (cond
	     ((or (and (eq? type 'integer) (integer? arg))
		  (and (eq? type 'string) (string? arg)))
	      (%curl-easy-setopt handle option arg))
	     ((eq? type 'boolean)
	      (%curl-easy-setopt handle option (c-bool arg)))
	     ((not (member type '(integer boolean string)))
	      (error (format #f "Unimplemented type: ~a" type)))
	     (else
	      (error (format #f "Wrong type arg: ~a" arg)))))
	  ;; else
	  (error (format #f "Unknown option: ~a" option)))))))

(define (curl-easy-perform h)
  "This function is called after the init and all the
curl-easy-setopt calls are made, and will perform the transfer as
described in the options.  It must be called with the same handle as
input as the curl_easy_init call returned."
  (%curl-easy-perform h))

(define (curl-error-string)
  "Returns information about the last error as a string."
  (%curl-error-string))

(define (curl-error-code)
  "Returns the libcurl error ID of the last error."
  (%curl-error-code))